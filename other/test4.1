
(DECLARE (*FEXPR RECEIVE CASES) (SETQ IBASE 10.) (SPECIAL :MESSAGE :MATCHED? :SELF) (SPECIAL C
OMPOSITE/.SOMETHING UNIVERSE SOMETHINGS/.PLAN:/.HANDLER SOMETHINGS/.REMOVE/.HANDLER SOMETHINGS
/.REPLACE/.HANDLER SOMETHING) (FASLOAD QQ)) 
(DECLARE (EVAL (READ))) 
(PROGN (DEFUN OPEN-BRACE-MACRO NIL (QUOTE {)) (DEFUN CLOSE-BRACE-MACRO NIL (QUOTE })) (SETSYNT
AX 123. (QUOTE MACRO) (QUOTE OPEN-BRACE-MACRO)) (SETSYNTAX 125. (QUOTE MACRO) (QUOTE CLOSE-BRA
CE-MACRO))) 
(DECLARE (SETQ :SELF COMPOSITE/.SOMETHING)) 
(SETQ COMPOSITE/.SOMETHING (QUOTE INTERNAL-COMPOSITE/.SOMETHING)) 

(DEFUN INTERNAL-COMPOSITE/.SOMETHING (:MESSAGE) 
       (CASES (RECEIVE (ASK PARTS ?MESSAGE)
		       (MAPC (FUNCTION (LAMBDA (PART) (ASK (EVAL PART) :MESSAGE)))
			     (ASK :SELF '(WHAT PARTS ?))))
	      (ELSE (PASS/.THE/.BUCK/.TO SOMETHING :MESSAGE :SELF))))
(DEFPROP INTERNAL-COMPOSITE/.SOMETHING (NAME KIND-OF) %MEMORY) 
(DEFPROP INTERNAL-COMPOSITE/.SOMETHING ((COMPOSITE/.SOMETHING)) NAME) 
(DEFPROP INTERNAL-COMPOSITE/.SOMETHING ((SOMETHING)) KIND-OF) 
(DECLARE (SETQ :SELF UNIVERSE)) 
(SETQ UNIVERSE (QUOTE INTERNAL-UNIVERSE)) 

(DEFUN INTERNAL-UNIVERSE (:MESSAGE) 
       (CASES
	(RECEIVE (DO IT)
		 (DO ((ACTORS/.WITH/.THINGS/.TO/.DO (ASK :SELF
							 '(FIND ALL
								ACTORS/.WITH/.THINGS/.TO/.DO
								?))
						    (ASK :SELF
							 '(FIND ALL
								ACTORS/.WITH/.THINGS/.TO/.DO
								?)))
		      (COUNT 1. (1+ COUNT)))
		     ((OR (NULL ACTORS/.WITH/.THINGS/.TO/.DO) (> COUNT *MAXIMUM-TICKS*))
		      (COND ((NULL ACTORS/.WITH/.THINGS/.TO/.DO) 'DONE)
			    (T (WARNING 'UNIVERSE
					'(`:SELF TICKED `COUNT TIMES)))))
		     (DO ((I ACTORS/.WITH/.THINGS/.TO/.DO (CDR I)))
			 ((NULL I))
			 (OR (ASK (CAR I)
				  '(TICK `:SELF)
				  '(EXAMPLE: (ASK SOMETHING '(TICK UNIVERSE-1)))))
			 (COND ((ASK (CAR I)
				     '(FIND ALL TO/.DO/.AT/.TIME ? ?)
				     '(EXAMPLE: (ASK SOMETHING
						     '(FIND ALL TO/.DO/.AT/.TIME 27.)))))
			       (T (ASK :SELF
				       '(FORGET ACTORS/.WITH/.THINGS/.TO/.DO (CAR I))
				       '(EXAMPLE: (FORGET ACTORS/.WITH/.THINGS/.TO/.DO
							  SALLY)))
				  (ASK (CAR I)
				       '(REPLACE RUN TIME 0.)
				       '(EXAMPLE: (ASK SOMETHING
						       '(REPLACE RUN TIME 0.)))))))))
	(ELSE (PASS/.THE/.BUCK/.TO SOMETHING :MESSAGE :SELF))))
(DEFPROP INTERNAL-UNIVERSE (NAME KIND-OF) %MEMORY) 
(DEFPROP INTERNAL-UNIVERSE ((UNIVERSE)) NAME) 
(DEFPROP INTERNAL-UNIVERSE ((SOMETHING)) KIND-OF) 
(DECLARE (SETQ :SELF SOMETHINGS/.PLAN:/.HANDLER)) 
(SETQ SOMETHINGS/.PLAN:/.HANDLER (QUOTE INTERNAL-SOMETHINGS/.PLAN:/.HANDLER)) 

(DEFUN INTERNAL-SOMETHINGS/.PLAN:/.HANDLER (:MESSAGE) 
       (CASES
	(RECEIVE (PLAN: %COMMAND NEXT)
		 (DO/.THE/.FOLLOWING: (ASK :SELF
					   '(REPLACE TIME `(1+ (ASK :SELF
								    '(WHAT TIME ?))))
					   '(EXAMPLE: (REPLACE TIME 5.)))
				      (ASK :SELF
					   '(REMEMBER TO/.DO/.AT/.TIME `(ASK :SELF
									     '(WHAT TIME ?)) `
:COMMAND)				   '(EXAMPLE: (REMEMBER TO/.DO/.AT/.TIME 5. (SHOW))))
				      (ASK UNIVERSE
					   '(REMEMBER ACTORS/.WITH/.THINGS/.TO/.DO `:SELF)
					   '(EXAMPLE: (REMEMBER ACTORS/.WITH/.THINGS/.TO/.DO
								SAM)))))
	(RECEIVE (PLAN: %COMMAND AFTER { NUMBERP ?NUMBER } TICKS)
		 (DO/.THE/.FOLLOWING: (ASK :SELF
					   '(REPLACE TIME `(+ (ASK :SELF
								   '(WHAT TIME ?))
							      (FIX :NUMBER)))
					   '(EXAMPLE: (REPLACE TIME 27.)))
				      (ASK :SELF
					   '(REMEMBER TO/.DO/.AT/.TIME `(ASK :SELF
									     '(WHAT TIME ?)) `
:COMMAND)				   '(EXAMPLE: (REMEMBER TO/.DO/.AT/.TIME 27. (HIDE))))
				      (ASK UNIVERSE
					   '(REMEMBER ACTORS/.WITH/.THINGS/.TO/.DO `:SELF)
					   '(EXAMPLE: (REMEMBER ACTORS/.WITH/.THINGS/.TO/.DO
								SAM)))))
	(RECEIVE (PLAN: %COMMAND THEN)
		 (DO/.THE/.FOLLOWING: (ASK :SELF
					   '(REMEMBER TO/.DO/.AT/.TIME `(ASK :SELF
									     '(WHAT TIME ?)) `
:COMMAND)				   '(EXAMPLE: (REMEMBER TO/.DO/.AT/.TIME
								23.
								(GROW 24.))))
				      (ASK UNIVERSE
					   '(REMEMBER ACTORS/.WITH/.THINGS/.TO/.DO `:SELF)
					   '(EXAMPLE: (REMEMBER ACTORS/.WITH/.THINGS/.TO/.DO
								SAM)))))
	(RECEIVE (PLAN: %COMMAND AFTER { NUMBERP ?NUMBER } MORE TICKS)
		 (DO/.THE/.FOLLOWING: (ASK :SELF
					   '(REMEMBER TO/.DO/.AT/.TIME `(+ (ASK :SELF
										'(WHAT RUN
										       TIME
										       ?))
									   (FIX :NUMBER)) `:CO
MMAND)					   '(EXAMPLE: (REMEMBER TO/.DO/.AT/.TIME
								12.
								(SHRINK 21.))))
				      (ASK UNIVERSE
					   '(REMEMBER ACTORS/.WITH/.THINGS/.TO/.DO `:SELF)
					   '(EXAMPLE: (REMEMBER ACTORS/.WITH/.THINGS/.TO/.DO
								SAM)))))
	(ELSE (PASS/.THE/.BUCK/.TO SOMETHING :MESSAGE :SELF))))
(DEFPROP INTERNAL-SOMETHINGS/.PLAN:/.HANDLER (NAME KIND-OF) %MEMORY) 
(DEFPROP INTERNAL-SOMETHINGS/.PLAN:/.HANDLER ((SOMETHINGS/.PLAN:/.HANDLER)) NAME) 
(DEFPROP INTERNAL-SOMETHINGS/.PLAN:/.HANDLER ((SOMETHING)) KIND-OF) 
(DECLARE (SETQ :SELF SOMETHINGS/.REMOVE/.HANDLER)) 
(SETQ SOMETHINGS/.REMOVE/.HANDLER (QUOTE INTERNAL-SOMETHINGS/.REMOVE/.HANDLER)) 

(DEFUN INTERNAL-SOMETHINGS/.REMOVE/.HANDLER (:MESSAGE) 
       (CASES (RECEIVE (REMOVE CLAUSE { NUMBERP ?CLAUSE/.NUMBER })
		       (REMOVE/.CLAUSE/.NUMBER :CLAUSE/.NUMBER :SELF))
	      (RECEIVE (REMOVE CLAUSE (% RECEIVE %PATTERN THEN %ACTION))
		       (REMOVE/.CLAUSE '(RECEIVE `:PATTERN `:ACTION) :SELF))
	      (RECEIVE (REMOVE CLAUSE (RECEIVE ?PATTERN ?ACTION))
		       (REMOVE/.CLAUSE '(RECEIVE `:PATTERN `:ACTION) :SELF))
	      (ELSE (PASS/.THE/.BUCK/.TO SOMETHING :MESSAGE :SELF))))
(DEFPROP INTERNAL-SOMETHINGS/.REMOVE/.HANDLER (NAME KIND-OF) %MEMORY) 
(DEFPROP INTERNAL-SOMETHINGS/.REMOVE/.HANDLER ((SOMETHINGS/.REMOVE/.HANDLER)) NAME) 
(DEFPROP INTERNAL-SOMETHINGS/.REMOVE/.HANDLER ((SOMETHING)) KIND-OF) 
(DECLARE (SETQ :SELF SOMETHINGS/.REPLACE/.HANDLER)) 
(SETQ SOMETHINGS/.REPLACE/.HANDLER (QUOTE INTERNAL-SOMETHINGS/.REPLACE/.HANDLER)) 

(DEFUN INTERNAL-SOMETHINGS/.REPLACE/.HANDLER (:MESSAGE) 
       (CASES (RECEIVE (REPLACE CLAUSE
				{
				NUMBERP
				?CLAUSE/.NUMBER
				}
				WITH
				(% RECEIVE %NEW/.PATTERN THEN %NEW/.ACTION))
		       (REPLACE/.CLAUSE/.NUMBER :CLAUSE/.NUMBER
						'(RECEIVE `:NEW/.PATTERN `:NEW/.ACTION)
						:SELF))
	      (RECEIVE (REPLACE PATTERN
				OF
				CLAUSE
				{
				NUMBERP
				?CLAUSE/.NUMBER
				}
				WITH
				%NEW/.PATTERN)
		       (REPLACE/.PART/.OF/.CLAUSE/.NUMBER 'PATTERN
							  :CLAUSE/.NUMBER
							  :NEW/.PATTERN
							  :SELF))
	      (RECEIVE (REPLACE PATTERN
				OF
				CLAUSE
				(% RECEIVE %OLD/.PATTERN THEN %OLD/.ACTION)
				WITH
				%NEW/.PATTERN)
		       (REPLACE/.PART/.OF/.CLAUSE 'PATTERN
						  '(RECEIVE `:OLD/.PATTERN `:OLD/.ACTION)
						  :NEW/.PATTERN
						  :SELF))
	      (RECEIVE (REPLACE ACTION
				OF
				CLAUSE
				{
				NUMBERP
				?CLAUSE/.NUMBER
				}
				WITH
				%NEW/.ACTION)
		       (REPLACE/.PART/.OF/.CLAUSE/.NUMBER 'ACTION
							  :CLAUSE/.NUMBER
							  :NEW/.ACTION
							  :SELF))
	      (RECEIVE (REPLACE PATTERN
				OF
				CLAUSE
				(% RECEIVE %OLD/.PATTERN THEN %OLD/.ACTION)
				WITH
				%NEW/.ACTION)
		       (REPLACE/.PART/.OF/.CLAUSE 'ACTION
						  '(RECEIVE `:OLD/.PATTERN `:OLD/.ACTION)
						  :NEW/.ACTION
						  :SELF))
	      (RECEIVE (REPLACE CLAUSE
				{
				NUMBERP
				?CLAUSE/.NUMBER
				}
				WITH
				(RECEIVE ?NEW/.PATTERN ?NEW/.ACTION))
		       (REPLACE/.CLAUSE/.NUMBER :CLAUSE/.NUMBER
						'(RECEIVE `:NEW/.PATTERN `:NEW/.ACTION)
						:SELF))
	      (RECEIVE (REPLACE CLAUSE
				(% RECEIVE %OLD/.PATTERN THEN %OLD/.ACTION)
				WITH
				(% RECEIVE %NEW/.PATTERN THEN %NEW/.ACTION))
		       (REPLACE/.CLAUSE '(RECEIVE `:OLD/.PATTERN `:OLD/.ACTION)
					'(RECEIVE `:NEW/.PATTERN `:NEW/.ACTION)
					:SELF))
	      (RECEIVE (REPLACE CLAUSE
				(RECEIVE ?OLD/.PATTERN ?OLD/.ACTION)
				WITH
				(RECEIVE ?NEW/.PATTERN ?NEW/.ACTION))
		       (REPLACE/.CLAUSE '(RECEIVE `:OLD/.PATTERN `:OLD/.ACTION)
					'(RECEIVE `:NEW/.PATTERN `:NEW/.ACTION)
					:SELF))
	      (RECEIVE (REPLACE %ITEM) (REPLACE :ITEM :SELF))
	      (ELSE (PASS/.THE/.BUCK/.TO SOMETHING :MESSAGE :SELF))))
(DEFPROP INTERNAL-SOMETHINGS/.REPLACE/.HANDLER (NAME KIND-OF) %MEMORY) 
(DEFPROP INTERNAL-SOMETHINGS/.REPLACE/.HANDLER ((SOMETHINGS/.REPLACE/.HANDLER)) NAME) 
(DEFPROP INTERNAL-SOMETHINGS/.REPLACE/.HANDLER ((SOMETHING)) KIND-OF) 
(DECLARE (SETQ :SELF SOMETHING)) 
(SETQ SOMETHING (QUOTE INTERNAL-SOMETHING)) 

(DEFUN INTERNAL-SOMETHING (:MESSAGE) 
       (CASES
	(RECEIVE (% RECEIVE %PATTERN THEN %ACTION) (INSERT-RECEIVE :PATTERN :ACTION :SELF))
	(RECEIVE (REMEMBER %ITEM) (REMEMBER :ITEM :SELF))
	(RECEIVE (FORGET %ITEM) (FORGET :ITEM :SELF))
	(RECEIVE ({ MEMQ
		    ?COMMAND
		    '(FIND WHAT RECALL)
		    }
		    CLAUSE
		    {
		    NUMBERP
		    ?CLAUSE/.NUMBER
		    })
		 (FIND/.CLAUSE :CLAUSE/.NUMBER :SELF))
	(RECEIVE (FIND ALL %PATTERN)
		 (COND ((EQ :SELF SOMETHING) (CAR (FIND-ALL :PATTERN :SELF)))
		       (T (UNION (CAR (FIND-ALL :PATTERN :SELF))
				 (ASK (CLASS-OF :SELF)
				      :MESSAGE
				      '(EXAMPLE: (ASK SOMETHING
						      '(FIND ALL FOO BARS))))))))
	(RECEIVE ({ MEMQ ?COMMAND '(FIND WHAT RECALL) } %PATTERN)
		 (OR (ATOM-IF-ONLY-ONE (NREVERSE (CAR (FIND/.ONE :PATTERN :SELF))))
		     (AND (NOT (EQ :SELF SOMETHING))
			  (ASK (CLASS-OF :SELF)
			       :MESSAGE
			       '(EXAMPLE: (ASK SOMETHING '(WHAT YOU DOING)))))))
	(RECEIVE (REPLACE %ANYTHING)
		 (PASS/.THE/.BUCK/.TO SOMETHINGS/.REPLACE/.HANDLER :MESSAGE :SELF))
	(RECEIVE (MAKE ?NAME)
		 ((LAMBDA (INTERNAL-NAME) 
			  (ASK INTERNAL-NAME
			       '(REMEMBER NAME `:NAME)
			       '(EXAMPLE: (ASK SOMETHING '(REMEMBER NAME SALLY))))
			  (SET (INTERN (APPEND-ATOMS ': :NAME)) INTERNAL-NAME)
			  (SET :NAME INTERNAL-NAME))
		  (MAKE-INSTANCE :SELF :NAME)))
	(RECEIVE (REMOVE %ANYTHING)
		 (PASS/.THE/.BUCK/.TO SOMETHINGS/.REMOVE/.HANDLER :MESSAGE :SELF))
	(RECEIVE (INTERCHANGE CLAUSE
			      {
			      NUMBERP
			      ?CLAUSE/.NUMBER1
			      }
			      ?AND/.OR/.WITH
			      {
			      NUMBERP
			      ?CLAUSE/.NUMBER2
			      })
		 ((LAMBDA (FIRST/.CLAUSE SECOND/.CLAUSE) 
			  (ASK :SELF
			       '(REPLACE CLAUSE `:CLAUSE/.NUMBER1 WITH `SECOND/.CLAUSE)
			       '(EXAMPLE: (REPLACE CLAUSE
						   5.
						   WITH
						   (RECEIVE (FOO BAR) (MUMBLE)))))
			  (ASK :SELF
			       '(REPLACE CLAUSE `:CLAUSE/.NUMBER2 WITH `FIRST/.CLAUSE)
			       '(EXAMPLE: (REPLACE CLAUSE
						   7.
						   WITH
						   (RECEIVE (MUMBLE) (FOO BAR))))))
		  (ASK :SELF
		       '(RECALL CLAUSE NUMBER `:CLAUSE/.NUMBER1)
		       '(EXAMPLE: (RECALL CLAUSE 5.)))
		  (ASK :SELF
		       '(RECALL CLAUSE NUMBER `:CLAUSE/.NUMBER2)
		       '(EXAMPLE: (RECALL CLAUSE 7.)))))
	(RECEIVE (INSERT CLAUSE
			 (% RECEIVE %PATTERN THEN %ACTION)
			 AFTER
			 CLAUSE
			 {
			 NUMBERP
			 ?NUMBER
			 })
		 (INSERT/.AFTER/.CLAUSE '(RECEIVE `:PATTERN `:ACTION)
					:NUMBER
					:SELF))
	(RECEIVE (INSERT CLAUSE (RECEIVE ?PATTERN ?ACTION) AFTER CLAUSE { NUMBERP ?NUMBER })
		 (INSERT/.AFTER/.CLAUSE '(RECEIVE `:PATTERN `:ACTION)
					:NUMBER
					:SELF))
	(RECEIVE (PLAN: %ANYTHING)
		 (PASS/.THE/.BUCK/.TO SOMETHINGS/.PLAN:/.HANDLER :MESSAGE :SELF))
	(RECEIVE (WAIT { NUMBERP ?NUMBER })
		 (ASK :SELF
		      '(REPLACE TIME `(1+ (ASK :SELF '(WHAT TIME ?))))
		      '(EXAMPLE: (REPLACE TIME 6.))))
	(RECEIVE
	 (TICK ?UNIVERSE)
	 (DO/.THE/.FOLLOWING:
	  ((LAMBDA (RUN/.TIME) 
		   (ASK :SELF
			'(REPLACE RUN TIME `(1+ RUN/.TIME))
			'(EXAMPLE: (REPLACE RUN TIME 12.)))
		   (MAPC 
		    (FUNCTION (LAMBDA (THING/.TO/.DO) 
				      (ASK :SELF THING/.TO/.DO '(EXAMPLE: ANYTHING))
				      (ASK :SELF
					   '(FORGET TO/.DO/.AT/.TIME `RUN/.TIME `THING/.TO/.DO
)					   '(EXAMPLE: (FORGET TO/.DO/.AT/.TIME
							      3.
							      (GO FORWARD 10.))))))
		    (ASK :SELF
			 '(FIND ALL TO/.DO/.AT/.TIME `RUN/.TIME ?)
			 '(EXAMPLE: (FIND ALL TO/.DO/.AT/.TIME 3. ?)))))
	   (ASK :SELF '(WHAT RUN TIME ?)))))
	(RECEIVE (SPRINT) (SPRINTER (CADDR (GET :SELF 'EXPR))))
	(RECEIVE (PRINT %OPTION) (FANCY-PRINT :SELF :OPTION))
	(ELSE (COMPLAIN :SELF '(DOESN/'T/ UNDERSTAND `:MESSAGE)))))
(DEFPROP INTERNAL-SOMETHING (RUN TIME NAME) %MEMORY) 
(DEFPROP INTERNAL-SOMETHING ((TIME 0.)) RUN) 
(DEFPROP INTERNAL-SOMETHING ((0.)) TIME) 
(DEFPROP INTERNAL-SOMETHING ((SOMETHING)) NAME) 
(DECLARE (SETSYNTAX 46. 139712. NIL)) 